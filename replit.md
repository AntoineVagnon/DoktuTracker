# Doktu - Telemedicine Platform

## Overview
Doktu is a professional telemedicine platform designed to connect patients with certified healthcare providers across Europe. Its core purpose is to facilitate secure video consultations, streamline appointment booking, and manage payment processing while adhering strictly to GDPR compliance and high security standards. The platform aims to be a leading solution for virtual healthcare, offering a comprehensive suite of tools for both patients and medical professionals.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The platform utilizes React with TypeScript for the frontend, styled with Tailwind CSS and shadcn/ui components for a modern and responsive user interface. Radix UI primitives are used for accessible components with custom theming. The design emphasizes a clean, intuitive interface with clear navigation, especially seen in the doctor's redesigned horizontal navigation matching the homepage header. Color schemes are professional, focusing on user accessibility and clarity.

### Technical Implementations
- **Frontend**: React with TypeScript, Vite for bundling, TanStack Query for server state management, and Wouter for routing.
- **Backend**: Node.js with Express.js and TypeScript, providing RESTful APIs with robust error handling and logging.
- **Authentication**: Uses Supabase Auth for secure user authentication, including comprehensive registration, login, password reset flows, and role-based access control for Patients, Doctors, and Admins.
- **Payment Processing**: Integrates Stripe for secure payment processing, supporting payment intents and subscription management with a focus on the European market (EUR currency) and PCI DSS compliance.
- **Database**: PostgreSQL with Neon serverless, managed via Drizzle ORM and Drizzle Kit for type-safe operations and schema migrations.
- **GDPR Compliance (Aug 2025)**: Implemented comprehensive GDPR Article 9 compliance for health data processing with legal documentation system, user consent management, and data processing records. Created Privacy Policy, Terms of Service, GDPR Compliance Statement, and Medical Disclaimer pages with full legal text compliant with EU regulations.
- **Phase 2 Consent Management System (Aug 2025)**: Implemented comprehensive consent management system including granular health data processing consent, marketing preferences, cookie consent banner with category-based preferences (essential, functional, analytics, marketing), consent withdrawal capabilities, GDPR data processing records tracking, and audit trail with IP/user agent logging. All consents are tracked per GDPR Article 6 and Article 9 requirements with proper legal basis documentation.
- **Core Features**:
    - **Doctor Management**: Comprehensive doctor profiles, real-time availability management with time slot locking, and verification (e.g., RPPS for France).
    - **Appointment System**: Real-time slot reservation, integrated Stripe payments, and full appointment lifecycle management. **Critical Fix (Aug 2025)**: Resolved slot availability filtering - booked appointments now correctly hide from available slots through proper UTC-to-local timezone conversion. **Enhancement (Aug 2025)**: Added appointment rescheduling and cancellation functionality with audit trails, 60-minute buffer enforcement, maximum 2 reschedules per appointment, and automatic refund eligibility determination. **Video Consultations (Aug 2025)**: Implemented Zoom-integrated video consultations with time-based access controls, equipment testing, doctor late/no-show handling, and post-consultation satisfaction surveys with star ratings and comments. **Patient Calendar (Jan 2025)**: Implemented read-only patient calendar view with modal-only appointment interactions, removed all availability management features (doctor-only), fixed duplicate UI elements and navigation errors. **Doctor Workflow Update (Jan 2025)**: Doctors can only cancel appointments (not reschedule directly) - cancellation automatically invites patients to reschedule.
    - **Administrative Dashboard**: Provides analytics, user management, appointment oversight, and revenue tracking. **Enhanced (Jan 2025)**: Added real-time meetings section displaying live video consultations, planned appointments, and connection issues with automatic refresh. **Data Integrity Fix (Aug 2025)**: Removed all mock/estimated data from admin metrics - acquisition channels now show real data only (no fake "Paid Search" traffic), feedback metrics use actual calculations from reviews and retention data, customer acquisition cost correctly shows 0 when no paid marketing is active.
    - **Critical Security Fixes (Aug 19, 2025)**: Implemented comprehensive security measures addressing 12 critical vulnerabilities: Secured `/api/doctors` endpoint removing email/RPPS/Stripe ID exposure, implemented server-side price validation preventing manipulation (€35 to €0.01 attacks), added DOMPurify XSS protection on all inputs, applied rate limiting (100 req/15min general, 5 req/15min auth, 30 req/hr sensitive endpoints), enforced security headers via Helmet middleware (CSP, X-Frame-Options, etc.), implemented generic error messages preventing information leakage, created secure checkout session with CSRF protection, enforced JWT authentication on critical endpoints, maintained SQL injection prevention via Drizzle ORM, enhanced session security with PostgreSQL storage, implemented bcrypt with 12 rounds for passwords, added comprehensive security audit logging. Security Dashboard available at `/security-dashboard` for real-time monitoring.
    - **Data Security Center (Aug 2025 - Phase 6)**: Comprehensive security management system storing all data in Supabase. Features AES-256-GCM encryption tracking for health data, role-based access control with 5 default roles (patient, doctor, admin, support, DPO), real-time audit logging of all data access attempts, encryption key rotation management, secure session handling with JWT tokens, data breach incident tracking, and security metrics dashboard. All 7 security tables (encryption_keys, access_control_roles, user_role_assignments, data_access_audit_log, encrypted_columns, secure_sessions, data_breach_incidents) are stored directly in Supabase database with proper indexes and row-level security.
    - **Medical Device Regulation (MDR) Compliance (Aug 2025 - Phase 4)**: Implemented comprehensive MDR assessment system for EU Medical Device Regulation 2017/745 compliance. Features MDCG 2019-11 decision tree evaluation, medical device classification (Not MD, Class I, IIa, IIb, III), risk assessment tracking, compliance requirements management, CE marking and notified body requirement determination. System evaluates whether Doktu qualifies as Medical Device Software (MDSW) and tracks all regulatory compliance requirements. Achieved 100% quality test pass rate.
    - **Professional Qualification Verification (Aug 2025 - Phase 5)**: Implemented comprehensive doctor verification system with EU-compliant credential management. Features medical qualification tracking (degrees, licenses, certifications), professional insurance verification, cross-border practice declarations for temporary and permanent establishment, EU Professional Card (EPC) management, automatic EU database verification simulation, language competency tracking, and multi-country recognition status. System ensures doctors meet all legal requirements to practice across EU member states. Achieved 95% quality test pass rate.
    - **Video Consultation System (Jan 2025)**: Fully integrated Zoom video consultation platform with Server-to-Server OAuth authentication. Features automatic meeting creation upon payment completion, professional video consultation interface with countdown timers and 10-minute early join window, secure meeting password display, HIPAA compliance messaging, and direct "Join Video Call" buttons in patient dashboard for seamless access to paid appointments. **Status**: Zoom app activated and fully operational as of January 15, 2025.
    - **Naming System**: Structured name system (title, firstName, lastName) consistently applied across the platform for users.
    - **Timezone Management**: Robust timezone handling ensures accurate display and storage of appointment times across all user interfaces. **Enhanced (Aug 2025)**: Fixed critical slot availability matching by implementing proper UTC+2 timezone conversion for European time zones.
    - **Enhanced Email System with Bulletproof Rendering (Aug 2025)**: Comprehensive email notification system with ICS calendar file attachments for all appointment confirmations. **Major UX Overhaul (Aug 2025)**: Completely rewritten email templates implementing bulletproof cross-client compatibility with table-based CTA buttons that work reliably across Gmail, Outlook, Apple Mail, and mobile clients. Features include proper Doktu logo placement with HTTPS hosting, timezone-aware datetime formatting with UTC storage and local display, comprehensive ICS calendar attachments for create/update/cancel operations, accessible plain-text alternatives, and Gmail clipping prevention (< 102KB HTML). All templates now use the Doktu Email UI Kit v2 with pixel-consistent brand alignment, mobile-first responsive design, and component-based structure ensuring 44×44px minimum touch targets and 4.5:1 contrast ratios. **Status (Aug 20, 2025)**: Email system fully tested and operational - successful template generation (10,297 bytes), proper timezone conversion (UTC→CEST), and bulletproof CTA buttons. SendGrid integration verified working (API key valid, FROM_EMAIL configured). Production-ready pending SendGrid quota upgrade.
    - **Membership Plan System (Aug 20, 2025)**: Comprehensive subscription management system implementing the PRD specifications. Features include two membership tiers (Monthly €45/month for 2 consultations, 6-Month €219 for 12 consultations with 23% savings), full Stripe subscription integration with secure payment processing, allowance tracking and cycle management, coverage determination for appointments (covered vs pay-per-visit), billing automation with webhook handling, membership status dashboard integration, and complete frontend UI with plan comparison, subscription forms, and success flows. Database schema includes 6 tables (membership_plans, membership_subscriptions, membership_cycles, membership_allowance_events, appointment_coverage, billing_attempts) for comprehensive tracking. **Status**: Core implementation complete with API routes, UI components, and Stripe integration - ready for testing once database schema is deployed.
    - **Document Management**: HIPAA/GDPR compliant document storage with encryption at rest/transit, access control lists (ACL), audit logging, and automatic PHI classification. Legacy document migration system guides users to re-upload through secure channels.

### System Design Choices
The architecture emphasizes a clear separation of concerns between frontend and backend. Data flow is designed for security and efficiency, from user registration through authentication and appointment booking. The system employs secure session management with PostgreSQL storage and adheres to role-based access control. Error handling is comprehensive, including global error suppression for a stable user experience. The design prioritizes scalability and maintainability through modular components and well-defined API structures.

**Medical Compliance**: All document storage implements HIPAA/GDPR compliance through encrypted object storage with comprehensive access controls. The system automatically classifies medical documents as PHI (Protected Health Information), applies encryption at rest and in transit, logs all access attempts for audit trails, and enforces role-based access permissions. Legacy documents from the pre-compliance era are handled with clear migration paths to ensure no data loss while maintaining security standards.

## External Dependencies

- **Neon Database**: Serverless PostgreSQL hosting.
- **Supabase**: Comprehensive authentication services (replacing previous Replit Auth).
- **Stripe**: Payment processing and subscription management.
- **Vite**: Frontend development server and build tool.
- **Drizzle Kit**: Database schema management and migration tool.
- **Tailwind CSS**: Utility-first CSS framework for styling.
- **Radix UI**: Accessible component primitives for UI building.
- **Lucide React**: Icon library.
```